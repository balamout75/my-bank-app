<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                            http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.31.xsd">

    <changeSet id="create-cash-operation-sequence" author="Ivan Vasilyev">
        <preConditions>
            <not><sequenceExists schemaName="cash" sequenceName="cash_operation_sequence"/></not>
        </preConditions>
        <createSequence schemaName="cash" sequenceName="cash_operation_sequence" startValue="1" incrementBy="1"/>
        <rollback>
            <dropSequence schemaName="cash" sequenceName="cash_operation_sequence"/>
        </rollback>
    </changeSet>

    <changeSet id="create-cash-operations-table" author="Ivan Vasilyev">
        <preConditions>
            <not><tableExists schemaName="cash" tableName="cash_operations"/></not>
        </preConditions>

        <createTable schemaName="cash" tableName="cash_operations">
            <column name="operation_id" type="BIGINT">
                <constraints primaryKey="true" nullable="false" primaryKeyName="cash_operations_pkey"/>
            </column>

            <column name="username" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>

            <!-- RESERVED допускает пустые amount/type -->
            <column name="amount" type="NUMERIC(19,2)">
                <constraints nullable="true"/>
            </column>

            <column name="type" type="VARCHAR(20)">
                <constraints nullable="true"/>
            </column>

            <column name="status" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>

            <column name="created_at" type="TIMESTAMP" defaultValueComputed="NOW()">
                <constraints nullable="false"/>
            </column>

            <column name="completed_at" type="TIMESTAMP">
                <constraints nullable="true"/>
            </column>

            <column name="error_message" type="TEXT">
                <constraints nullable="true"/>
            </column>

            <column name="notification_attempts" type="INT" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>

            <column name="notification_error" type="TEXT"/>

            <column name="notification_attempts_at" type="TIMESTAMP" defaultValueComputed="NOW()">
                <constraints nullable="false"/>
            </column>

        </createTable>

        <!-- CHECK constraints (Postgres) -->
        <sql>
            ALTER TABLE cash.cash_operations
                ADD CONSTRAINT chk_status
                    CHECK (status IN ('RESERVED','RECEIVED', 'IN_PROGRESS', 'UPDATED', 'NOTIFIED', 'UNNOTIFIED', 'FAILED'));

            -- type может быть NULL в RESERVED
            ALTER TABLE cash.cash_operations
                ADD CONSTRAINT chk_type
                    CHECK (type IS NULL OR type IN ('DEPOSIT','WITHDRAW'));

            -- при любом статусе, кроме RESERVED, amount/type обязаны быть заполнены
            ALTER TABLE cash.cash_operations
                ADD CONSTRAINT chk_required_fields_when_not_reserved
                    CHECK (
                        status = 'RESERVED'
                            OR (amount IS NOT NULL AND type IS NOT NULL)
                        );
        </sql>

        <rollback>
            <dropTable schemaName="cash" tableName="cash_operations"/>
        </rollback>
    </changeSet>

    <!-- Индексы -->
    <changeSet id="index-cash-ops-username" author="Ivan Vasilyev">
        <preConditions>
            <not><indexExists schemaName="cash" indexName="idx_cash_ops_username"/></not>
        </preConditions>
        <createIndex schemaName="cash" tableName="cash_operations" indexName="idx_cash_ops_username">
            <column name="username"/>
        </createIndex>
        <rollback>
            <dropIndex schemaName="cash" indexName="idx_cash_ops_username" tableName="cash_operations"/>
        </rollback>
    </changeSet>

    <changeSet id="index-cash-ops-status" author="Ivan Vasilyev">
        <preConditions onFail="MARK_RAN">
            <not><indexExists schemaName="cash" indexName="idx_cash_ops_status"/></not>
        </preConditions>
        <createIndex schemaName="cash" tableName="cash_operations" indexName="idx_cash_ops_status">
            <column name="status"/>
        </createIndex>
        <rollback>
            <dropIndex schemaName="cash" indexName="idx_cash_ops_status" tableName="cash_operations"/>
        </rollback>
    </changeSet>

    <changeSet id="04-index-cash-ops-created" author="Ivan Vasilyev">
        <preConditions onFail="MARK_RAN">
            <not><indexExists schemaName="cash" indexName="idx_cash_ops_created"/></not>
        </preConditions>
        <sql>
            CREATE INDEX IF NOT EXISTS idx_cash_ops_created
                ON cash_operations (created_at DESC);
        </sql>
        <rollback>
            <dropIndex schemaName="cash" indexName="idx_cash_ops_created" tableName="cash_operations"/>
        </rollback>
    </changeSet>

</databaseChangeLog>
